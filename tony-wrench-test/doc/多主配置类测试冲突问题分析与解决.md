# Spring Boot 多主配置类测试冲突问题分析与解决

## 1. 问题现象

在执行 `DynamicConfigCenterStarterTest` 测试用例时，出现如下报错：

```
java.lang.IllegalStateException: Found multiple @SpringBootConfiguration annotated classes [...]
```

## 2. 问题原因分析

### 2.1 @SpringBootApplication 注解的作用

- `@SpringBootApplication` 是 Spring Boot 应用的入口注解，本质上是一个组合注解：
  - `@SpringBootConfiguration`（继承自`@Configuration`，标记主配置类）
  - `@EnableAutoConfiguration`
  - `@ComponentScan`
- Spring Boot 启动或测试时，会自动扫描依赖包下所有的 `@SpringBootConfiguration` 注解类。
- **一个Spring Boot应用只能有一个主配置类（`@SpringBootConfiguration`）**，否则Spring Boot无法确定哪个是应用的主入口。

### 2.2 具体冲突场景

- 你的主工程（`tony-wrench-test`）有一个主类：`TonyWrenchTestApplication`，带有`@SpringBootApplication`。
- 你的starter模块（`tony-wrench-starter-dynamic-config-center`）也有一个主类：`TonyWrenchStarterDynamicConfigCenterApplication`，同样带有`@SpringBootApplication`。
- 测试模块依赖了starter模块，Spring Boot测试环境会扫描到两个主配置类，导致冲突。

## 3. 解决思路

### 3.1 推荐做法
- **Starter模块不应该有`@SpringBootApplication`主类**，只需要自动配置类（`@Configuration`）和属性类。
- 业务/测试模块才需要`@SpringBootApplication`主类。

### 3.2 其他可选做法
- 在测试类上用 `@SpringBootTest(classes = 主配置类.class)` 显式指定主配置类。
- 但根本解决方案还是不要在starter里放主类。

## 4. 具体操作步骤

### 4.1 删除starter模块中的主配置类

删除文件：
```
ton-wrench-starter-dynamic-config-center/src/main/java/com/study/tony/wrench/TonyWrenchStarterDynamicConfigCenterApplication.java
```

### 4.2 在测试类中指定主配置类（保险做法）

修改测试类注解：
```java
@SpringBootTest(classes = TonyWrenchTestApplication.class)
public class DynamicConfigCenterStarterTest {
    // ...
}
```

### 4.3 重新编译并安装starter模块

```bash
cd tony-wrench-starter-dynamic-config-center
mvn clean install
```

### 4.4 确认测试模块依赖和配置无误
- 测试模块依赖starter模块
- 测试模块有自己的主配置类
- 测试用例可以正常运行

## 5. 为什么 @SpringBootApplication 导致该问题？

- `@SpringBootApplication` 注解会让类成为Spring Boot应用的主配置类（`@SpringBootConfiguration`）。
- Spring Boot 测试环境（如`@SpringBootTest`）会自动扫描所有依赖包下的主配置类。
- 如果有多个主配置类，Spring Boot无法确定哪个是应用的入口，**就会抛出“Found multiple @SpringBootConfiguration annotated classes”异常**。
- 这也是为什么官方Starter和三方Starter都不会包含`@SpringBootApplication`主类的原因。

## 6. 总结

- **Starter模块不要有主配置类，只做自动配置和属性绑定。**
- **业务/测试模块才需要主配置类。**
- **如遇到多主配置类冲突，优先删除starter中的主类，或在测试类上指定主类。**
- 这样可以保证Spring Boot测试环境的唯一性和可维护性。

---

> 通过上述操作，已成功解决多主配置类导致的Spring Boot测试冲突问题。 